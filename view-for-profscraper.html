<html>
    <head>
        <title>Profcoach - Weekresultaat voor teams in selectie</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.1.1/css/bootstrap-combined.min.css" rel="stylesheet">

        <style type="text/css">
          body {
            padding-top: 60px;
            padding-bottom: 40px;
          }
           .badges{margin:10px 0 0;}
           .pclogo {float:right;width:5.2em;}
           .swlogo {float:right;width:7.2em;}
           .gerardlogo {float:right;}
           #errormsg { display:none; }
        </style>
    </head>

<body>
   <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="#">Profcoach - Weekresultaat voor teams in selectie</a>
        </div><!-- /.container -->
      </div><!-- /.navbar-inner -->
    </div><!-- /.navbar -->

    <div class="container">

        <div id="ModelZakKlapvdWeek" class="modal fade hide" role="dialog" aria-labelledby="ModelZakKlapvdWeekLabel" aria-hidden="True">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h3>Klapper/Zakker van de week!</h3>
          </div>
          <div class="modal-body">
            <div id="table_klapperzakker"></div>
          </div>
          <div class="modal-footer">
            <a href="#" class="btn" data-dismiss="modal" aria-hidden="true">Close</a>
          </div>
        </div>

      <!-- Example row of columns -->
      <div class="row">
        <div class="span4">
          <h2>Over Profcoach</h2>
           <p><img class="pclogo" src="https://www.profcoach.nl/Content/themes/general/images/Layout/logo.png" title="logo profcoach.nl">Profcoach is een Nederlands voetbalmanagement spel waarmee punten te zijn verdienen. Je kan individueel meedoen, maar leuker is het om het samen in een subleague te doen.</p>
          <p><a class="btn" href="http://www.profcoach.nl">naar Profcoach.nl &raquo;</a></p>
        </div>
        <div class="span4">
          <h2>Over deze pagina</h2>
           <p><img class="swlogo" src="https://media.scraperwiki.com/images/footer_tractor.png" title="logo scraperwiki">Deze view is gemaakt door <a href="http://rubenwoudsma.nl" title="Website van Ruben Woudsma">Ruben Woudsma</a> en maakt gebruik van de scraper <a href="https://classic.scraperwiki.com/scrapers/profscraper1314/" title="Source scraperdatabase that is being used">ProfScraper1314</a>. Maak er gebruik van om je eigen subleague resultaten op te bouwen.</p>
          <p><a class="btn" href="https://scraperwiki.com/scrapers/profscraper1314/">Scraper bekijken &raquo;</a></p>
       </div>
        <div class="span4">
          <h2>Speelronde selectie</h2>
            <p>Via onderstaande selectie is het mogelijk om informatie uit een andere speelronde te tonen:</p>
            <form id="round-selection">
                <div class="input-append">
                    <select id="PCRoundSelection">
                        <option value="selecteren">Selecteer een speelronde</option>
                    </select>
                    <button type="submit" class="btn btn-info">Selecteer</button>
                </div>
            </form>
            <button type="button" data-toggle="modal" data-target="#ModelZakKlapvdWeek" class="btn">Klapper/zakker van de week</button>
        </div>
      </div> <!-- row -->

      <!-- Example row of columns -->
      <div class="row" id="loadingcont">
        <div class="span12">
          <div class="well">
            <div id="loading" class="progress progress-striped active">
              <div class="bar" style="width: 100%;">Gegevens ophalen en verwerken tot grafieken.</div>
            </div>
            <div id="errormsg" class="alert alert-error">
              <button type="button" class="close" data-dismiss="alert">&times;</button>
              <strong>Error!</strong> Helaas is er een probleem opgetreden tijdens het verwerken van de resultaten.
            </div>
          </div>
        </div>
      </div>  <!-- row -->

      <!-- Example row of columns -->
      <div class="row">
        <div class="span8">
           <h2>Profcoach - Weekresultaat <span id="pcweekresult"></span></h2>
           <div id="chart_div"></div>
        </div>
        <div class="span4">
           <h2>Spelersinformatie</h2>
           <p>Overzicht van de meest geselecteerde spelers binnen de subleague over de laatste speelronde.</p>
           <div id="table_div"></div>
        </div>
      </div>  <!-- row -->

      <!-- Example row of columns -->
      <div class="row">
        <div class="span6">
           <h2>En de winnaar is?</h2>
           <p>De winnaar van deze speelronde is: <strong><span id="winnaaris">DUMMYTEKST</span></strong>. Met een score van <span id="winnaarscore">000</span> en een rendement van <span id="winnaarrendement">88,99</span>% was er niemand die nog kon tippen aan deze score.</p>
            <p id="winnaarisextra"></p>
        </div>
        <div class="span6">
           <h2>Gerard Kemkers trofee!</h2>
           <p><img src="http://www.medianed.com/wp-content/uploads/2010/02/kemkerskramer.jpg" class="img-polaroid gerardlogo">Traditioneel gezien wordt deze prijs toegekend aan de manager met de slechtste wissels. Op basis van de bankscore van <span id="gerardbank">22</span> en een rendement van slechts <span id="gerardrendement">34,55</span>% kan deze prijs niet anders gaan dan naar: <strong><span id="gerardtroffee">DUMMY</span></strong>.</p>
        </div>
      </div>  <!-- row -->

      <!-- Example row of columns -->
      <div class="row" id="loadingcont">
        <div class="span12">
           <h2>Weektotaaloverzicht in tabel!</h2>
           <p>Onderstaand overzicht is de tabelweergave van de grafiek welke hierboven gebruikt wordt. Voordeel van deze tabel is dat de kolommen te sorteren zijn voor verdere analyse van de resultaten.</p>
           <div id="tabletotaal_div"></div>
        </div>
      </div>  <!-- row -->

      <hr>

    </div>

   <footer class="footer">
      <div class="container">
        <p><a href="http://rubenwoudsma.nl" title="website ontwikkelaar scraper/view voor profcoach.nl"><img src="http://rubenwoudsma.nl/wp-content/uploads/2011/10/logo-nieuwe-site-poging4.png"></a></p>
            <div class="badges">
            <span><a href="https://twitter.com/rubenwoudsma" class="twitter-follow-button" data-show-count="false" data-size="large">Volg @rubenwoudsma</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script></span> <span><a href="https://twitter.com/share" class="twitter-share-button" data-via="psychemedia" data-size="large" data-hashtags="OUoniPlayer">Tweet</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script></span>
            </div>
        <p class="pull-right"><a href="#">Back to top</a></p>
        <p>Ontwerp en layout gebouwd op basis van <a href="http://twitter.github.com/bootstrap/index.html">Twitter Bootstrap</a> op <a href="http:/github.com/">github.com</a>.</p>
      </div>
   </footer>

   <!-- Javascript - placed at the bottom for faster loading of the site -->
   <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
   <script type="text/javascript" src="https://www.google.com/jsapi"></script>
   <script type="text/javascript" src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.1.1/js/bootstrap.min.js"></script>

   <script type="text/javascript">

        google.load("visualization", "1", {packages:["table", "corechart"]});
        google.setOnLoadCallback(initialize);

        function initialize() {
            // The URL here is the URL of the SQLLite API.
            // Other information is used to query the dataset.

            var apimorph = "https://api.morph.io/rubenwoudsma/profscraper1314/data.json";
            var morphkey = "TNBd3rYa1tgWDy0ZYSux";
            
            var sqlselect = "select team_name, team_roundscore, team_benchscore, team_maxscore, team_round, team_totalscore from pcteams where team_round in (select distinct team_round from pcteams order by CAST(replace(team_round, 'speelronde ', '') AS SIGNED) desc limit 1) order by team_roundscore desc, team_benchscore desc";
            var sqlselectplayers = "select player_name, count(*) as in_teams, sum(player_captain = 'Ja') as iscaptain, sum(player_position = 'Basisspeler') as opgesteld from pcteamplayers where player_round in (select distinct team_round from pcteams order by CAST(replace(team_round, 'speelronde ', '') AS SIGNED) desc limit 1) group by player_name order by in_teams desc limit 12";
            var sqlpcrounds = "select distinct team_round from pcteams order by CAST(replace(team_round, 'speelronde ', '') AS SIGNED) limit 30";
            var sqlextrainfo = "select t1.team_name, t1.team_round, t1.team_totalscore as current_rndscore, t2.team_totalscore as previous_rndscore from pcteams t1 join pcteams t2 on t1.team_id = t2.team_id and t2.team_round in (select t2.team_round from pcteams t2 where t2.team_id == t1.team_id order by CAST(replace(t2.team_round, 'speelronde ', '') AS SIGNED) desc limit 1 offset 1) where t1.team_round in ( select distinct t3.team_round from pcteams t3 order by CAST(replace(t3.team_round, 'speelronde ', '') AS SIGNED) desc limit 1 ) limit 20";

            console.log ('start AJAX calls for JSONLISTS');
            
						$.ajax({url: apimorph + "?key=" + morphkey + "&query=" + encodeURI(sqlselect), dataType: 'jsonp', success:ProcessTeamInfo, error: ProcessError });
						$.ajax({url: apimorph + "?key=" + morphkey + "&query=" + encodeURI(sqlselectplayers), dataType: 'jsonp', success:ProcessPlayerInfo, error: ProcessError });
						$.ajax({url: apimorph + "?key=" + morphkey + "&query=" + encodeURI(sqlpcrounds), dataType: 'jsonp', success:FillSelectList, error: ProcessError });
						$.ajax({url: apimorph + "?key=" + morphkey + "&query=" + encodeURI(sqlextrainfo), dataType: 'jsonp', success:ProcessAdditionalInfo, error: ProcessError });
            
            jQuery('#loadingcont').hide();
        }

        function refreshData(SpecificPlayRound) {

            console.log ('START: refreshing displayed information with data for: ' + SpecificPlayRound);
            jQuery("#loadingcont").show();

            var apimorph = "https://api.morph.io/rubenwoudsma/profscraper1314/data.json";
            var morphkey = "TNBd3rYa1tgWDy0ZYSux";

            var sqlselect = "select team_name, team_roundscore, team_benchscore, team_maxscore, team_round, team_totalscore from pcteams where team_round = '" + SpecificPlayRound + "' order by team_roundscore desc, team_benchscore desc";
            var sqlselectplayers = "select player_name, count(*) as in_teams, sum(player_captain = 'Ja') as iscaptain, sum(player_position = 'Basisspeler') as opgesteld from pcteamplayers where player_round = '" + SpecificPlayRound + "' group by player_name order by in_teams desc limit 12";

						$.ajax({url: apimorph + "?key=" + morphkey + "&query=" + encodeURI(sqlselect), dataType: 'jsonp', success:ProcessTeamInfo, error: ProcessError });
						$.ajax({url: apimorph + "?key=" + morphkey + "&query=" + encodeURI(sqlselectplayers), dataType: 'jsonp', success:ProcessPlayerInfo, error: ProcessError });
						
            jQuery('#loadingcont').hide();

            console.log ('END: refreshing displayed information with data for: ' + SpecificPlayRound);

        }

        function FillSelectList(tdata) {
            var PlayRound;

            jQuery.each(tdata, function(key, value){
                $('#PCRoundSelection').append('<option val="' + value.team_round + '">' + value.team_round + '</option>');
            });

            $( "#round-selection" ).submit(function( event ) {
                PlayRound = $('#PCRoundSelection').find(":selected").text();
                refreshData(PlayRound);
                event.preventDefault();
            });

        }

        function ProcessTeamInfo(tdata) {
            console.log ('START: Processing teaminformation');

            var weekwinner, winnerscore, winnerbench, winnereff;
            var gerardname, gerardscore, gerardbench, gerardeff;
            var weekmaxwinner, weekmaxscore = 0, weekmaxnormal, weekmaxeff;
            var wkGKT = 100;
            var PCRound;
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Teamname');
            data.addColumn('number', 'RoundScore');
            data.addColumn('number', 'BenchScore');
            data.addColumn('number', 'MaxScore');
            data.addColumn('number', 'Rendement');
            data.addColumn('number', 'TotalScore');
            data.addRows(tdata.length);
            for (var i = 0; i < tdata.length; i++)
            {
                data.setValue(i, 0, tdata[i].team_name);
                var tScore = parseFloat(tdata[i].team_roundscore);
                var tBench = parseFloat(tdata[i].team_benchscore);
                var tMax = parseFloat(tdata[i].team_maxscore);
                var tEff = Math.round(((tScore / tMax ) * 100)*100)/100;
                data.setValue(i, 1, tScore);
                data.setValue(i, 2, tBench);
                data.setValue(i, 3, tMax);
                data.setValue(i, 4, tEff);
                data.setValue(i, 5, parseFloat(tdata[i].team_totalscore));

                if (i==0) {
                    weekwinner = tdata[i].team_name;
                    winnerscore = tScore;
                    winnerbench = tBench;
                    winnereff = tEff;
                    PCRound = tdata[i].team_round;
                    UpdatePCData ( weekwinner, winnerscore, winnerbench, winnereff, "winner" );
                }

                if (winnerscore <= tMax && weekmaxscore <= tMax) {
                    weekmaxwinner = tdata[i].team_name;
                    weekmaxscore = tMax;
                    weekmaxnormal = tScore;
                    weekmaxeff = tEff;
                }

                if (tEff < wkGKT) {
                    wkGKT = tEff;
                    gerardname = tdata[i].team_name;
                    gerardscore = tScore;
                    gerardbench = tBench;
                    gerardeff  = tEff;
                }
            }

            console.log("  Intermediate: Start cloning dataset");
            var datacopy = data.clone();
            data.removeColumn(5);

            console.log("  Intermediate: Building the ComboChart for graphics on the page");
            var chart = new google.visualization.ComboChart(document.getElementById('chart_div'));
            chart.draw(data, {width: 630, height: 380, legend: {position: "top"}, chartArea:{left:20,top:30,width:"100%",height:"75%"}, seriesType: "bars", series: {3: {type: "line"} } });

            console.log("  Intermediate: Building the Table for the totals below on the page");
            var table = new google.visualization.Table(document.getElementById('tabletotaal_div'));
            table.draw(datacopy, {showRowNumber: true, pageSize: 20});

            console.log("  Intermediate: Displaying some text based upon values to add some additional information for the viewers");
            UpdatePCData ( gerardname, gerardscore, gerardbench, gerardeff , "gerardkemkers" );
            jQuery('#pcweekresult').text(PCRound);
            if (weekwinner != weekmaxwinner) {
                jQuery('#winnaarisextra').text('Helaas en jammer voor ' + weekmaxwinner + ' aangezien deze manager met een maximaal haalbare score van ' + weekmaxscore +  ' er ook met de weekprijs vandoor had kunnen gaan. Nu heeft deze manager slechts een score van ' +  weekmaxnormal + ' en kwam ' + weekmaxwinner + ' niet hoger dan een rendement van ' + weekmaxeff + '%. Een volgende speelronde beter!');
            } else {
                jQuery('#winnaarisextra').text('Gelukkig voor ' + weekwinner + ' was er deze ronde geen enkele andere manager goed genoeg om op basis van de maximaal haalbare score deze manager te verslaan.');
            }

            console.log ('END: Finished processing team information');

        }
        
        function UpdatePCData ( uname, uscore, ubench, ueff, utype) {

            if (utype == "winner") {
                jQuery('#winnaaris').text(uname);
                jQuery('#winnaarscore').text(uscore);
                jQuery('#winnaarrendement').text(ueff);
            } else if (utype = "gerardkemkers") {
                jQuery('#gerardtroffee').text(uname);
                jQuery('#gerardbank').text(ubench);
                jQuery('#gerardrendement').text(ueff);
            }

        }

        function ProcessPlayerInfo(tdata) {
        
            console.log ('START: Processing player information');
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Spelernaam');
            data.addColumn('number', 'Selectie?');
            data.addColumn('number', 'Opgesteld?');
            data.addColumn('number', 'Captain?');
            data.addRows(tdata.length);

            console.log ('  Intermediate: processing player information for a total of: ' + tdata.length);

            for (var i = 0; i < tdata.length; i++)
            {
                data.setValue(i, 0, tdata[i].player_name);
                var tInteams = parseFloat(tdata[i].in_teams);
                var tTimesCaptain = parseFloat(tdata[i].iscaptain);
                var tBasisPlayer = parseFloat(tdata[i].opgesteld);
                data.setValue(i, 1, tInteams );
                data.setValue(i, 2, tBasisPlayer );
                data.setValue(i, 3, tTimesCaptain );

            }

            var table = new google.visualization.Table(document.getElementById('table_div'));
            table.draw(data, {showRowNumber: false, pageSize: 10});

            console.log ('END: Processing player information');

        }


        function ProcessAdditionalInfo(tdata) {

            console.log ('START: Processing additional team information');
						
            console.log ('  Intermediate: Sorting the array and adding additional information');
            var data = tdata;
            // Sort on previous rank.
            var sorted = data.sort(function(a, b) {
                return b.previous_rndscore - a.previous_rndscore;
            });
            // Add extra column.
            var extraColumn = sorted.map(function(arrayRow, index) {
                arrayRow['PreviousRank'] = index + 1;
                return arrayRow;
            });
            // Sort on current rank.
            var secondsort = extraColumn.sort(function(a, b) {
                return b.current_rndscore - a.current_rndscore;
            });
            // Add extra extra column.
            var secondColumn = secondsort.map(function(arrayRow, index) {
                arrayRow['CurrentRank'] = index + 1;
                return arrayRow;
            });
            // Add count/diff column.
            var diffColumn = secondsort.map(function(arrayRow, index) {
                arrayRow['Diff_prev_cur'] = arrayRow['PreviousRank']-arrayRow['CurrentRank'];
                return arrayRow;
            });
            console.log ('  Intermediate: Creating Google DataTable and add the additional information');
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Teamname');
            data.addColumn('number', 'Prevpnts');
            data.addColumn('number', 'Prevpos');
            data.addColumn('number', 'Curpnts');
            data.addColumn('number', 'Curpos');
            data.addColumn('number', 'Diff');
            data.addRows(diffColumn.length);

            for (var i = 0; i < diffColumn.length; i++)
            {
								//Columnnames: team_name, team_round, current_rndscore, previous_rndscore, PreviousRank, CurrentRank, Diff_prev_cur
                data.setValue(i, 0, diffColumn[i]['team_name'] );
                data.setValue(i, 1, diffColumn[i]['previous_rndscore'] );
                data.setValue(i, 2, diffColumn[i]['PreviousRank'] );
                data.setValue(i, 3, diffColumn[i]['current_rndscore'] );
                data.setValue(i, 4, diffColumn[i]['CurrentRank'] );
                data.setValue(i, 5, diffColumn[i]['Diff_prev_cur'] );

            }

            var table = new google.visualization.Table(document.getElementById('table_klapperzakker'));
            var formatterArrow = new google.visualization.ArrowFormat();
                formatterArrow.format(data, 5);

            table.draw(data, {showRowNumber: false, pageSize: 10});

        }

        function ProcessError() {

            jQuery("#errormsg").show();

        }

    </script>

</body>
</html>
